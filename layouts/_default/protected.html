{{ define "main" }}
{{ $password := .Params.password }}

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">{{ .Title }}</h1>
    <div class="post-meta">
      <span>{{ .Date.Format "2006-01-02" }}</span>
      {{ if .Params.categories }}
        <span class="post-categories">
          {{ range .Params.categories }}<a href="{{ "/categories/" | relURL }}{{ . | urlize }}">{{ . }}</a>{{ end }}
        </span>
      {{ end }}
    </div>
  </header>

  {{ if $password }}
  <!-- å¯†ç ä¿æŠ¤åŒºåŸŸ -->
  <div id="password-gate" style="padding: 40px; text-align: center; background: var(--code-bg); border-radius: 8px; margin: 20px 0;">
    <p style="margin-bottom: 20px;">ğŸ”’ è¿™æ˜¯ä¸€ç¯‡ç§å¯†æ–‡ç« ï¼Œéœ€è¦å¯†ç è®¿é—®</p>
    <input type="password" id="pwd-input" placeholder="è¯·è¾“å…¥å¯†ç " style="padding: 10px 15px; border: 1px solid var(--border); border-radius: 4px; background: var(--entry); color: var(--primary); font-size: 16px;">
    <button onclick="checkPassword()" style="padding: 10px 20px; margin-left: 10px; background: var(--primary); color: var(--theme); border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">è§£é”</button>
    <p id="pwd-error" style="color: #e74c3c; margin-top: 15px; display: none;">å¯†ç é”™è¯¯</p>
  </div>
  
  <div id="protected-content" style="display: none;">
    <div class="post-content">
      {{ $encoded := .Content | base64Encode }}
      <div data-encoded="{{ $encoded }}" data-password="{{ $password }}"></div>
      <div id="decoded-content"></div>
    </div>
  </div>

  <script>
  function checkPassword() {
    const input = document.getElementById('pwd-input').value;
    const correctPwd = '{{ $password }}';
    
    if (input === correctPwd) {
      document.getElementById('password-gate').style.display = 'none';
      document.getElementById('protected-content').style.display = 'block';
      
      // è§£ç å¹¶æ˜¾ç¤ºå†…å®¹
      const encodedDiv = document.querySelector('[data-encoded]');
      const encoded = encodedDiv.getAttribute('data-encoded');
      try {
        const decoded = atob(encoded);
        document.getElementById('decoded-content').innerHTML = decoded;
      } catch (e) {
        document.getElementById('decoded-content').innerHTML = '<p style="color: #e74c3c;">å†…å®¹è§£ç å¤±è´¥</p>';
      }
    } else {
      document.getElementById('pwd-error').style.display = 'block';
    }
  }
  
  // æ”¯æŒå›è½¦é”®æäº¤
  document.getElementById('pwd-input')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') checkPassword();
  });
  </script>
  {{ else }}
  <div class="post-content">
    {{ .Content }}
  </div>
  {{ end }}

  <footer class="post-footer">
    {{ if .Params.tags }}
    <ul class="post-tags">
      {{ range .Params.tags }}<li><a href="{{ "/tags/" | relURL }}{{ . | urlize }}">{{ . }}</a></li>{{ end }}
    </ul>
    {{ end }}
  </footer>
</article>
{{ end }}